<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯ÙˆØ±ÙŠ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… â€” ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</title>
<style>
:root{
  --bg1:#061021; --bg2:#0f2a5a; --accent:#ffb800; --cyan:#00e0ff; --card:#0f1730cc; --muted:#9aa4bf;
  --success:#18d26e; --danger:#e74c3c; --radius:14px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:system-ui, Arial, sans-serif; color:#fff;
  background:
    radial-gradient(800px 400px at 10% 10%, #07173755, transparent 20%),
    linear-gradient(135deg, var(--bg1), var(--bg2));
  min-height:100vh;
}
.container{max-width:1100px;margin:20px auto;padding:18px}
.card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 10px 30px #00000055;border:1px solid #ffffff12}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.row{display:flex;gap:10px;flex-wrap:wrap}
button{background:var(--accent);color:#1b1300;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
button.ghost{background:transparent;border:1px dashed #ffffff33;color:#fff}
button.secondary{background:#21345a;color:#fff}
button.danger{background:var(--danger);color:#fff}
input,select{padding:8px;border-radius:10px;border:1px solid #334278;background:#0b1632;color:#fff;min-width:120px}
.table{overflow:auto;margin-top:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;text-align:center;border-bottom:1px solid #ffffff12}
thead th{background:#0b1b3f;position:sticky;top:0}
.pair{display:flex;gap:10px;align-items:center;flex-wrap:wrap;border-radius:10px;padding:8px;background:#081229;border:1px solid #ffffff10;margin:6px 0}
.vs{font-weight:800}
.bad{color:var(--danger)}
.ok{color:var(--success)}
.tag{padding:6px 10px;background:#ffffff10;border-radius:999px}
.ball{width:56px;height:56px;position:fixed;right:12px;bottom:12px;background:url('https://upload.wikimedia.org/wikipedia/commons/d/d3/Soccerball.svg') center/contain no-repeat;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.hidden{display:none}
.muted{color:var(--muted);font-size:13px}
.muted{
  font-size: 35px;
  text-align: center;
  font-weight: bold;
}
.card h3{
  text-align: center;
  font-size: 30px;
}
</style>
</head>
<body>
<div class="ball" aria-hidden="true"></div>
<div class="container" id="page-main">
  <div class="card header">
    <h1> Ø§Ù„Ù…Ø§Ø±Ø«ÙˆÙ† Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ù„Ø£Ø¨Ø±Ø§Ø´ÙŠÙ‡ Ø¨Ø±Ø¬ Ø§Ù„Ø¹Ø±Ø¨ ÙˆØ§Ù„Ø¹Ø§Ù…Ø±ÙŠÙ‡</h1>
    <div class="row">
      <button onclick="enterAudience()">Ø£Ù†Ø§ Ù…Ù† Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</button>
      <button class="secondary" onclick="enterOrganizer()">Ø£Ù†Ø§ Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…ÙŠÙ†</button>
    </div>
  </div>
  <div class="card" style="margin-top:12px">
    <h3>Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø±Ø§Ø¹ÙŠ </h3>
    <div class="muted">
          Ø¥ÙÙ†Ù’ ÙƒÙØ§Ù†ÙØªÙ’ ØªÙØ³Ù’Ù„ÙÙŠÙØ©ÙŒ Ù…ÙØ§ Ù„ÙÙ„Ù’Ù…ÙØ­ÙØ¨ÙÙ‘Ø©Ù.
    </div>
  </div>
</div>
<!-- Login -->
<div class="container hidden" id="page-login">
  <div class="card header">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø¸Ù…</h2>
    <div class="row">
      <input id="login-user" placeholder="user" />
      <input id="login-pass" placeholder="pass" type="password" />
      <button onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
      <button class="ghost" onclick="goHome()">Ø±Ø¬ÙˆØ¹</button>
    </div>
    <div class="muted" style="width:100%;">Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <b>admin</b> / <b>1234</b></div>
  </div>
</div>
<!-- Audience -->
<div class="container hidden" id="page-audience">
  <div class="card header">
    <h2>Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†)</h2>
    <div class="row">
      <button class="ghost" onclick="goHome()">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
  </div>
  <div id="audience-groups"></div>
  <div id="audience-brackets"></div>
</div>
<!-- Organizer -->
<div class="container hidden" id="page-org">
  <div class="card header">
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø¸Ù…</h2>
    <div class="row">
      <button class="ghost" onclick="goHome()">Ø®Ø±ÙˆØ¬</button>
      <button class="danger" onclick="resetAll()">Ù…Ø³Ø­ Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
    </div>
  </div>
  <div class="card">
    <h3>1) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ±Ù‚</h3>
    <div class="row">
      <input id="team-input" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚" />
      <button onclick="addTeam()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±ÙŠÙ‚</button>
      <button class="secondary" onclick="runGroupsDraw()">ğŸ² Ù‚Ø±Ø¹Ø© ÙˆØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
    </div>
    <div id="teams-list" class="row" style="margin-top:10px"></div>
  </div>
  <div class="card">
    <h3>2) Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø§Ù„ØªØ±ØªÙŠØ¨) + Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª (Schedule)</h3>
    <div id="org-groups"></div>
  </div>
  <div class="card">
    <h3>3) Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø¥Ù‚ØµØ§Ø¦ÙŠØ©</h3>
    <div class="row" style="margin-bottom:8px">
      <button onclick="createKnockoutFromGroups()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙŠ (Ù…Ù† Ø§Ù„Ù…ØªØ£Ù‡Ù„ÙŠÙ†)</button>
      <button class="secondary" onclick="advanceKnockout('R2','R3')">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù„Ø«</button>
      <button class="secondary" onclick="advanceKnockout('R3','SF')">Ø¥Ù†Ø´Ø§Ø¡ Ù†ØµÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
      <button class="secondary" onclick="advanceFinals()">Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ + Ù…Ø¨Ø§Ø±Ø§Ø© Ø«Ø§Ù„Ø«</button>
    </div>
    <div id="org-brackets"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  // ============================================
  // ğŸ”¥ Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Configuration Ù‡Ù†Ø§
  // ============================================
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyCHpkIlf8A13cL6TLggr7-3u8FM-PxzfSY",
    authDomain: "activitiescommittee-5b22c.firebaseapp.com",
    projectId: "activitiescommittee-5b22c",
    storageBucket: "activitiescommittee-5b22c.firebasestorage.app",
    messagingSenderId: "378991885059",
    appId: "1:378991885059:web:d8db039a6fc569fffb8736"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window.firebaseDB = db;
  window.firebaseRef = ref;
  window.firebaseSet = set;
  window.firebaseOnValue = onValue;
  window.firebaseRemove = remove;

  console.log('âœ… Firebase Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
</script>

<script>
/* Keys and initial state */
const AUTH = {user:'admin', pass:'1234'};
const state = {
  teams: [],
  groups: [],
  standings: [],
  matches: [],
  knockout: {}
};

// ============================================
// ğŸ”¥ Firebase Functions (Ø¨Ø¯Ù„ localStorage)
// ============================================
function saveAll(){
  const dbRef = window.firebaseRef(window.firebaseDB, 'leagueData');
  window.firebaseSet(dbRef, {
    teams: state.teams,
    groups: state.groups,
    standings: state.standings,
    matches: state.matches,
    knockout: state.knockout
  }).catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err));
}

function loadAll(){
  const dbRef = window.firebaseRef(window.firebaseDB, 'leagueData');
  window.firebaseOnValue(dbRef, (snapshot) => {
    if(snapshot.exists()){
      const data = snapshot.val();
      state.teams = data.teams || [];
      state.groups = data.groups || [];
      state.standings = data.standings || [];
      state.matches = data.matches || [];
      state.knockout = data.knockout || {};
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const currentPage = document.querySelector('.container:not(.hidden)');
      if(currentPage){
        if(currentPage.id === 'page-org') renderOrganizer();
        if(currentPage.id === 'page-audience') renderAudience();
      }
      renderTeamsList();
    }
  });
}

/* Navigation */
function show(id){
  document.querySelectorAll('[id^="page-"]').forEach(e=>e.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
function goHome(){ show('page-main') }
function enterOrganizer(){ show('page-login') }
function enterAudience(){ show('page-audience'); renderAudience(); }
function doLogin(){
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value.trim();
  if(u===AUTH.user && p===AUTH.pass){ show('page-org'); renderOrganizer(); }
  else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙ„Ø·');
}

/* Teams */
function addTeam(){
  const v = document.getElementById('team-input').value.trim();
  if(!v) return;
  if(state.teams.includes(v)){ alert('Ø§Ù„ÙØ±ÙŠÙ‚ Ù…ÙˆØ¬ÙˆØ¯'); return; }
  state.teams.push(v);
  document.getElementById('team-input').value='';
  saveAll(); renderTeamsList();
}
function renderTeamsList(){
  const wrap = document.getElementById('teams-list'); 
  if(!wrap) return;
  wrap.innerHTML='';
  state.teams.forEach((t,i)=>{
    const el = document.createElement('div'); el.className='tag'; el.style.display='inline-flex'; el.style.gap='8px';
    el.innerHTML = `<span>âš½ ${t}</span> <button class="ghost" onclick="removeTeam(${i})">Ø­Ø°Ù</button>`;
    wrap.appendChild(el);
  });
}
function removeTeam(i){ state.teams.splice(i,1); saveAll(); renderTeamsList(); }

/* Draw groups & create schedule (each pair once) */
function runGroupsDraw(){
  if(state.teams.length < 4){ alert('Ø³Ø¬Ù„ 4 ÙØ±Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
  const shuffled = [...state.teams].sort(()=>Math.random()-0.5);
  state.groups = [];
  for(let i=0;i<shuffled.length;i+=4) state.groups.push(shuffled.slice(i,i+4));
  state.standings = state.groups.map(g => g.map(name=>({name, played:0, win:0, draw:0, lose:0, gf:0, ga:0, pts:0, yellow:0, red:0})));
  state.matches = state.groups.map(g=>{
    const pairs = [];
    for(let i=0;i<g.length;i++){
      for(let j=i+1;j<g.length;j++){
        pairs.push({a:g[i], b:g[j], sA:null, sB:null, yA:0, yB:0, rA:0, rB:0, played:false});
      }
    }
    return pairs;
  });
  state.knockout = {};
  saveAll(); renderGroupsOrg(); renderAudience();
  alert('ØªÙ… Ø¹Ù…Ù„ Ø§Ù„Ù‚Ø±Ø¹Ø© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©');
}

/* Sorting rules */
function sortGroup(arr){
  return arr.slice().sort((A,B)=>{
    const gdA = A.gf - A.ga, gdB = B.gf - B.ga;
    if(B.pts !== A.pts) return B.pts - A.pts;
    if(gdB !== gdA) return gdB - gdA;
    if(A.red !== B.red) return A.red - B.red;
    if(A.yellow !== B.yellow) return A.yellow - B.yellow;
    if(B.gf !== A.gf) return B.gf - A.gf;
    return A.name.localeCompare(B.name,'ar');
  });
}

/* Recalculate standings from all recorded matches */
function rebuildStandings(){
  state.standings = state.groups.map(g => g.map(name=>({name, played:0, win:0, draw:0, lose:0, gf:0, ga:0, pts:0, yellow:0, red:0})));
  state.matches.forEach((groupMatches, gi)=>{
    groupMatches.forEach(m=>{
      if(m.played && Number.isFinite(m.sA) && Number.isFinite(m.sB)){
        const g = state.standings[gi];
        const A = g.find(x=>x.name===m.a);
        const B = g.find(x=>x.name===m.b);
        if(!A || !B) return;
        A.played++; B.played++;
        A.gf += m.sA; A.ga += m.sB; B.gf += m.sB; B.ga += m.sA;
        A.yellow += (m.yA||0); B.yellow += (m.yB||0);
        A.red += (m.rA||0); B.red += (m.rB||0);
        if(m.sA > m.sB){ A.win++; B.lose++; A.pts += 3; }
        else if(m.sA < m.sB){ B.win++; A.lose++; B.pts += 3; }
        else { A.draw++; B.draw++; A.pts++; B.pts++; }
      }
    });
  });
  saveAll();
}

/* Organizer: render groups + schedule + match editors */
function renderGroupsOrg(){
  const host = document.getElementById('org-groups'); 
  if(!host) return;
  host.innerHTML='';
  if(!state.groups.length){ host.innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ø¹Ø¯ â€” Ù‚Ù… Ø¨Ø§Ù„Ù‚Ø±Ø¹Ø©</div>'; return; }
  state.groups.forEach((g, gi)=>{
    const c = document.createElement('div'); c.className='card';
    const sorted = sortGroup(state.standings[gi] || []);
    let html = `<h3>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${gi+1}</h3>
      <div class="table"><table><thead><tr>
      <th>Ø§Ù„ÙØ±ÙŠÙ‚</th><th>Ù„Ø¹Ø¨</th><th>ÙÙˆØ²</th><th>ØªØ¹Ø§Ø¯Ù„</th><th>Ø®Ø³Ø§Ø±Ø©</th>
      <th>Ù„Ù‡</th><th>Ø¹Ù„ÙŠÙ‡</th><th>ÙØ±Ù‚</th><th>Ù†Ù‚Ø§Ø·</th><th>Ø¥Ù†Ø°Ø§Ø±</th><th>Ø·Ø±Ø¯</th>
      </tr></thead><tbody>`;
    sorted.forEach(t=>{
      html += `<tr><td>${t.name}</td><td>${t.played}</td><td>${t.win}</td><td>${t.draw}</td><td>${t.lose}</td>
        <td>${t.gf}</td><td>${t.ga}</td><td>${t.gf - t.ga}</td><td><b>${t.pts}</b></td><td>${t.yellow}</td><td>${t.red}</td></tr>`;
    });
    html += `</tbody></table></div>`;
    html += `<div style="margin-top:10px"><h4>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª (Schedule)</h4>`;
    const matches = state.matches[gi] || [];
    if(!matches.length) html += `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª</div>`;
    matches.forEach((m, mi)=>{
      html += `<div class="pair" id="m-${gi}-${mi}">
        <span>${m.a}</span>
        <span class="vs">â€”</span>
        <span>${m.b}</span>
        <input type="number" id="m-${gi}-${mi}-a" placeholder="Ø£Ù‡Ø¯Ø§Ù ${m.a}" style="width:90px" value="${m.sA===null?'':m.sA}" />
        <input type="number" id="m-${gi}-${mi}-b" placeholder="Ø£Ù‡Ø¯Ø§Ù ${m.b}" style="width:90px" value="${m.sB===null?'':m.sB}" />
        <input type="number" id="m-${gi}-${mi}-yA" placeholder="Ø¥Ù†Ø°Ø§Ø±Ø§Øª ${m.a}" style="width:120px" value="${m.yA||0}" />
        <input type="number" id="m-${gi}-${mi}-yB" placeholder="Ø¥Ù†Ø°Ø§Ø±Ø§Øª ${m.b}" style="width:120px" value="${m.yB||0}" />
        <input type="number" id="m-${gi}-${mi}-rA" placeholder="Ø·Ø±Ø¯ ${m.a}" style="width:100px" value="${m.rA||0}" />
        <input type="number" id="m-${gi}-${mi}-rB" placeholder="Ø·Ø±Ø¯ ${m.b}" style="width:100px" value="${m.rB||0}" />
        <button onclick="saveMatchResult(${gi},${mi})">${m.played? 'ØªØ­Ø¯ÙŠØ«' : 'Ø­ÙØ¸'}</button>
        <button class="ghost" onclick="clearMatchResult(${gi},${mi})">Ù…Ø³Ø­ Ù†ØªÙŠØ¬Ø©</button>
      </div>`;
    });
    html += `</div>`;
    c.innerHTML = html;
    host.appendChild(c);
  });
}

/* Save match result, then rebuild standings from all matches */
function saveMatchResult(gi, mi){
  const m = state.matches[gi][mi];
  const sA = document.getElementById(`m-${gi}-${mi}-a`).value;
  const sB = document.getElementById(`m-${gi}-${mi}-b`).value;
  if(sA === '' || sB === '') { if(!confirm('Ø³Ø¬Ù„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙƒÙ€0 Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ Ø°Ù„ÙƒØŸ')) return; }
  const a = parseInt(sA||'0',10), b = parseInt(sB||'0',10);
  const yA = parseInt(document.getElementById(`m-${gi}-${mi}-yA`).value||'0',10);
  const yB = parseInt(document.getElementById(`m-${gi}-${mi}-yB`).value||'0',10);
  const rA = parseInt(document.getElementById(`m-${gi}-${mi}-rA`).value||'0',10);
  const rB = parseInt(document.getElementById(`m-${gi}-${mi}-rB`).value||'0',10);
  m.sA = a; m.sB = b; m.yA = yA; m.yB = yB; m.rA = rA; m.rB = rB; m.played = true;
  rebuildStandings();
  renderGroupsOrg(); renderAudience(); saveAll();
}

/* Clear a match (make it unplayed) and rebuild standings */
function clearMatchResult(gi, mi){
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ù†ØªÙŠØ¬Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©ØŸ')) return;
  const m = state.matches[gi][mi];
  m.sA = null; m.sB = null; m.yA=0; m.yB=0; m.rA=0; m.rB=0; m.played=false;
  rebuildStandings(); renderGroupsOrg(); renderAudience(); saveAll();
}

/* Knockout functions */
function topTwoFromGroupIndex(gi){ return sortGroup(state.standings[gi]||[]).slice(0,2).map(x=>x.name) }

function createKnockoutFromGroups(){
  if(!state.groups.length) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª'); return; }
  const qualified = []; for(let i=0;i<state.groups.length;i++) qualified.push(...topTwoFromGroupIndex(i));
  if(qualified.length < 2) { alert('Ø§Ù„Ù…ØªØ£Ù‡Ù„ÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù„Ø§Ø²Ù…'); return; }
  const shuffled = qualified.sort(()=>Math.random()-0.5);
  const pairs = []; for(let i=0;i<shuffled.length;i+=2) if(shuffled[i+1]) pairs.push({a:shuffled[i], b:shuffled[i+1], sA:null,sB:null, winner:null, loser:null});
  state.knockout.R2 = pairs; saveAll(); renderBracketsOrg(); renderAudience(); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ø§Ù„Ù…ØªØ£Ù‡Ù„ÙŠÙ†');
}

function advanceKnockout(fromKey,toKey){
  const from = state.knockout[fromKey];
  if(!from || !from.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±'); return; }
  const winners = from.filter(p=>p.winner).map(p=>p.winner);
  if(winners.length !== from.length){ alert('Ø³Ø¬Ù‘Ù„ Ù†ØªØ§Ø¦Ø¬ ÙƒÙ„ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ± Ø£ÙˆÙ„Ø§'); return; }
  const shuffled = winners.sort(()=>Math.random()-0.5);
  const next = []; for(let i=0;i<shuffled.length;i+=2) if(shuffled[i+1]) next.push({a:shuffled[i], b:shuffled[i+1], sA:null,sB:null, winner:null, loser:null});
  state.knockout[toKey] = next; saveAll(); renderBracketsOrg(); renderAudience(); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ');
}

function advanceFinals(){
  const sf = state.knockout.SF; if(!sf || !sf.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØµÙ Ù†Ù‡Ø§Ø¦ÙŠ'); return; }
  if(sf.some(p=>!p.winner)){ alert('Ø³Ø¬Ù„ Ù†ØªØ§Ø¦Ø¬ Ù†ØµÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const winners = sf.map(p=>p.winner), losers = sf.map(p=>p.loser);
  state.knockout.F = [{a:winners[0], b:winners[1], sA:null,sB:null, winner:null, loser:null}];
  state.knockout.P3 = [{a:losers[0], b:losers[1], sA:null,sB:null, winner:null, loser:null}];
  saveAll(); renderBracketsOrg(); renderAudience(); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø«');
}

function renderBracketsOrg(){
  const host = document.getElementById('org-brackets'); 
  if(!host) return;
  host.innerHTML='';
  const order = [['R2','Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙŠ'],['R3','Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù„Ø«'],['SF','Ù†ØµÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ'],['F','Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ'],['P3','Ù…Ø±ÙƒØ² Ø«Ø§Ù„Ø«']];
  order.forEach(([k,label])=>{
    const list = state.knockout[k] || [];
    const card = document.createElement('div'); card.className='card';
    let html = `<h4>${label}</h4>`;
    if(!list.length) html += `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>`;
    list.forEach((p, idx)=>{
      html += `<div class="pair">
        <span>${p.a}</span><input type="number" id="${k}-a-${idx}" placeholder="Ø£Ù‡Ø¯Ø§Ù ${p.a}" style="width:80px" value="${p.sA===null?'':p.sA}" />
        <span class="vs">:</span>
        <input type="number" id="${k}-b-${idx}" placeholder="Ø£Ù‡Ø¯Ø§Ù ${p.b}" style="width:80px" value="${p.sB===null?'':p.sB}" />
        <button onclick="saveBracketResult('${k}',${idx})">Ø­ÙØ¸</button>
        ${p.winner? `<span class="ok">Ø§Ù„ÙØ§Ø¦Ø²: ${p.winner}</span>` : ''}
        ${p.loser? `<span class="bad">Ø§Ù„Ø®Ø§Ø³Ø±: ${p.loser}</span>` : ''}
      </div>`;
    });
    card.innerHTML = html; host.appendChild(card);
  });
}

function saveBracketResult(stage, idx){
  const list = state.knockout[stage]; if(!list) return;
  const p = list[idx];
  const sA = parseInt(document.getElementById(`${stage}-a-${idx}`).value||'0',10);
  const sB = parseInt(document.getElementById(`${stage}-b-${idx}`).value||'0',10);
  if(isNaN(sA) || isNaN(sB)){ alert('Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©'); return; }
  p.sA = sA; p.sB = sB;
  if(sA===sB){ alert('Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø¥Ù‚ØµØ§Ø¦ÙŠØ© ØªØ­ØªØ§Ø¬ ÙØ§Ø¦Ø² (Ø³Ø¬Ù‘Ù„ Ù†ØªÙŠØ¬Ø© Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø¶Ø¹ Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„ØªØ±Ø¬ÙŠØ­)'); return; }
  p.winner = sA>sB? p.a : p.b; p.loser = sA>sB? p.b : p.a;
  saveAll(); renderBracketsOrg(); renderAudience();
}

/* Audience render */
function renderAudience(){
  const gHost = document.getElementById('audience-groups'); 
  if(!gHost) return;
  gHost.innerHTML='';
  state.groups.forEach((g, gi)=>{
    const sorted = sortGroup(state.standings[gi] || []);
    const card = document.createElement('div'); card.className='card';
    let html = `<h3>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ${gi+1}</h3><div class="table"><table><thead><tr>
      <th>Ø§Ù„ÙØ±ÙŠÙ‚</th><th>Ù„Ø¹Ø¨</th><th>ÙÙˆØ²</th><th>ØªØ¹Ø§Ø¯Ù„</th><th>Ø®Ø³Ø§Ø±Ø©</th><th>Ù„Ù‡</th><th>Ø¹Ù„ÙŠÙ‡</th><th>ÙØ±Ù‚</th><th>Ù†Ù‚Ø§Ø·</th><th>Ø¥Ù†Ø°Ø§Ø±</th><th>Ø·Ø±Ø¯</th>
      </tr></thead><tbody>`;
    sorted.forEach(t=> html += `<tr><td>${t.name}</td><td>${t.played}</td><td>${t.win}</td><td>${t.draw}</td><td>${t.lose}</td>
      <td>${t.gf}</td><td>${t.ga}</td><td>${t.gf - t.ga}</td><td><b>${t.pts}</b></td><td>${t.yellow}</td><td>${t.red}</td></tr>`);
    html += `</tbody></table></div><details style="margin-top:10px"><summary>Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</summary>`;
    const matches = state.matches[gi] || [];
    matches.forEach(m=> html += `<div class="pair">${m.a} ${m.played? '('+m.sA+':'+m.sB+')' : '(Ù„Ù… ØªÙØ³Ø¬Ù‘Ù„)'} <span style="margin-inline:8px">â€”</span> ${m.b}</div>`);
    html += `</details>`;
    card.innerHTML = html; gHost.appendChild(card);
  });

  const bHost = document.getElementById('audience-brackets'); 
  if(!bHost) return;
  bHost.innerHTML='';
  const order = [['R2','Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙŠ'],['R3','Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù„Ø«'],['SF','Ù†ØµÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ'],['F','Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ'],['P3','Ù…Ø±ÙƒØ² Ø«Ø§Ù„Ø«']];
  order.forEach(([k,label])=>{
    const list = state.knockout[k]; if(!list || !list.length) return;
    const card = document.createElement('div'); card.className='card';
    let html = `<h3>${label}</h3>`;
    list.forEach(p=> html += `<div class="pair">${p.a} ${(p.sA===null?'':'('+p.sA+':'+p.sB+')')} â€” ${p.b} ${p.winner? `<span class="ok"> (ÙØ§Ø¦Ø²: ${p.winner})</span>`:''}</div>`);
    card.innerHTML = html; bHost.appendChild(card);
  });
}

/* Organizer render */
function renderOrganizer(){ renderTeamsList(); renderGroupsOrg(); renderBracketsOrg(); }

/* Reset all */
function resetAll(){
  if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return;
  state.teams=[]; state.groups=[]; state.standings=[]; state.matches=[]; state.knockout={};
  saveAll(); renderOrganizer(); renderAudience(); alert('ØªÙ… Ø§Ù„Ù…Ø³Ø­');
}

/* init - ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase */
window.addEventListener('DOMContentLoaded', () => {
  loadAll();
  renderTeamsList();
});
</script>
</body>
</html>